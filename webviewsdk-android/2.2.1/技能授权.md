# 技能授权

智能设备端接入技能授权后，能够引导用户登录自己的QQ音乐等账号，从而能够在音箱访问自己账号下的内容资源。

在接入前，请确保根据[接入指南](/doc/page/303)完成了SDK的集成。

接入技能授权的主要流程为：

 * 设置设备信息
 * 完成音箱端授权并设置TVSToken
 * 处理WebView的回调信息
 * 打开目标URL

接下来会逐步展示各步骤的实现方法。demo中亦包含了覆盖以上步骤的完整实现。

## 设置设备信息

由于该业务Web页面运行在智能硬件端，因此需要讲设备信息传入到WebView组件中。通过下面的代码设置设备信息：

```java
TVSDevice tvsDevice = new TVSDevice();
tvsDevice.productID = "设备的ProductID";
tvsDevice.dsn = "设备的DSN";
// mController为TVSWebController类，请参考接入指南
mController.setDeviceInfo(tvsDevice);
```

## 设置TVSToken

为了完成Web页面内的鉴权，您需要获得该设备的TVSToken。设备端授权获取TVSToken的流程请参考文档[TVS SDK Android接入说明](https://dingdang.qq.com/doc/page/322)。

获取Token之后通过下面的代码注入到WebView组件中：

```java
mController.setTVSToken("设备的TVSToken");
```

## 处理WebView回调

TVSWebView组件提供了常用的回调，如加载进度、页面标题等。通过下面的代码设置回调：

```java
// 设置WebUI相关回调事件处理（包括加载状态）
mController.setUIEventListener(new WebDemoUIEventListener());
// 设置叮当内置JS回调
mController.setBusinessEventListener(new WebDemoBusinessEventListener());
```

WebView组件提供的回调接口说明请参阅Javadoc文档。对于技能授权，您至少需要实现`com.tencent.ai.tvs.web.TVSWebController.BusinessEventListener#requireCloseWebView`，以响应WebView中页面的关闭界面请求：

```java
public class WebDemoActivity extends AppCompatActivity {
    // Other codes...
    private class WebDemoBusinessEventListener implements TVSWebController.BusinessEventListener {
        @Override
        public void requireCloseWebView() {
            finish();
        }

        // Other codes...
    }
}
```

## 打开目标URL

通过下面的代码加载QQ音乐授权的URL：

```java
mController.toPresetURL(EUserAttrType.QQMUSIC_QRLOGIN);
```

> 注意：避免直接加载包含域名的URL，因为不同环境的URL的域名不同，且加载非当前环境的URL会导致Cookie设置失效等问题导致接入异常。
