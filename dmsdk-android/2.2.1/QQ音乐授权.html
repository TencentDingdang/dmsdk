<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>DM SDK & WebView SDK文档归档 |  </title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/dmsdk/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/dmsdk/favicon.ico">

    

  <meta name="generator" content="Hexo 4.2.0"></head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"path":"dmsdk-android/2.2.1/QQ音乐授权.html","title":""},"data":{"navigation":{"logo":{"text":"文档归档","type":"label"},"main":[{"text":"DM SDK Android","type":"label"},{"text":"2.2.1","type":"link","path":"dmsdk-android/2.2.1/接入指南.html","children":[{"text":"UniAccess接口","type":"link","path":"dmsdk-android/2.2.1/UniAccess接口.html"},{"text":"QQ音乐授权","type":"link","path":"dmsdk-android/2.2.1/QQ音乐授权.html"},{"text":"常见问题","type":"link","path":"dmsdk-android/2.2.1/常见问题.html"},{"text":"更新日志","type":"link","path":"dmsdk-android/2.2.1/更新日志.html"},{"text":"API文档","type":"link","path":"https://tencentdingdang.github.io/dmsdk/android/2.2.1/javadoc/index.html"}]},{"text":"2.3.0","type":"link","path":"dmsdk-android/2.3.0/接入指南.html","children":[{"text":"UniAccess接口","type":"link","path":"dmsdk-android/2.3.0/UniAccess接口.html"},{"text":"QQ音乐授权","type":"link","path":"dmsdk-android/2.3.0/QQ音乐授权.html"},{"text":"常见问题","type":"link","path":"dmsdk-android/2.3.0/常见问题.html"},{"text":"更新日志","type":"link","path":"dmsdk-android/2.3.0/更新日志.html"},{"text":"API文档","type":"link","path":"https://tencentdingdang.github.io/dmsdk/android/2.3.0/javadoc/index.html"}]},{"text":"DM SDK iOS","type":"label"},{"text":"2.3.1","type":"link","path":"dmsdk-ios/2.3.1/接入指南.html","children":[{"text":"UniAccess接口","type":"link","path":"dmsdk-ios/2.3.1/UniAccess接口.html"},{"text":"QQ音乐授权","type":"link","path":"dmsdk-ios/2.3.1/QQ音乐授权.html"},{"text":"常见问题","type":"link","path":"dmsdk-ios/2.3.1/常见问题.html"},{"text":"更新日志","type":"link","path":"dmsdk-ios/2.3.1/更新日志.html"},{"text":"API文档","type":"label","children":[{"text":"账号管理","type":"link","path":"dmsdk-ios/2.3.1/API文档/账号管理.html"},{"text":"web页面","type":"link","path":"dmsdk-ios/2.3.1/API文档/web页面.html"},{"text":"技能服务","type":"link","path":"dmsdk-ios/2.3.1/API文档/技能服务.html"},{"text":"语音设置","type":"link","path":"dmsdk-ios/2.3.1/API文档/语音设置.html"},{"text":"会员管理","type":"link","path":"dmsdk-ios/2.3.1/API文档/会员管理.html"}]}]},{"text":"2.3.0","type":"link","path":"dmsdk-ios/2.3.0/接入指南.html","children":[{"text":"UniAccess接口","type":"link","path":"dmsdk-ios/2.3.0/UniAccess接口.html"},{"text":"QQ音乐授权","type":"link","path":"dmsdk-ios/2.3.0/QQ音乐授权.html"},{"text":"常见问题","type":"link","path":"dmsdk-ios/2.3.0/常见问题.html"},{"text":"更新日志","type":"link","path":"dmsdk-ios/2.3.0/更新日志.html"},{"text":"API文档","type":"label","children":[{"text":"账号管理","type":"link","path":"dmsdk-ios/2.3.0/API文档/账号管理.html"},{"text":"web页面","type":"link","path":"dmsdk-ios/2.3.0/API文档/web页面.html"},{"text":"技能服务","type":"link","path":"dmsdk-ios/2.3.0/API文档/技能服务.html"},{"text":"语音设置","type":"link","path":"dmsdk-ios/2.3.0/API文档/语音设置.html"},{"text":"会员管理","type":"link","path":"dmsdk-ios/2.3.0/API文档/会员管理.html"}]}]},{"text":"2.2.1","type":"link","path":"dmsdk-ios/2.2.1/接入指南.html","children":[{"text":"UniAccess接口","type":"link","path":"dmsdk-ios/2.2.1/UniAccess接口.html"},{"text":"QQ音乐授权","type":"link","path":"dmsdk-ios/2.2.1/QQ音乐授权.html"},{"text":"常见问题","type":"link","path":"dmsdk-ios/2.2.1/常见问题.html"},{"text":"更新日志","type":"link","path":"dmsdk-ios/2.2.1/更新日志.html"},{"text":"API文档","type":"label","children":[{"text":"账号管理","type":"link","path":"dmsdk-ios/2.2.1/API文档/账号管理.html"},{"text":"web页面","type":"link","path":"dmsdk-ios/2.2.1/API文档/web页面.html"},{"text":"技能服务","type":"link","path":"dmsdk-ios/2.2.1/API文档/技能服务.html"},{"text":"语音设置","type":"link","path":"dmsdk-ios/2.2.1/API文档/语音设置.html"},{"text":"会员管理","type":"link","path":"dmsdk-ios/2.2.1/API文档/会员管理.html"}]}]},{"text":"WebView SDK","type":"label"},{"text":"2.2.1","type":"link","path":"webviewsdk-android/2.2.1/接入指南.html","children":[{"text":"技能授权","type":"link","path":"webviewsdk-android/2.2.1/技能授权.html"},{"text":"离线UI模版","type":"link","path":"webviewsdk-android/2.2.1/离线UI模版.html"},{"text":"常见问题","type":"link","path":"webviewsdk-android/2.2.1/常见问题.html"},{"text":"API文档","type":"link","path":"https://tencentdingdang.github.io/WebViewSDK/android/2.2.1/javadoc/index.html"}]}]}},"config":{"timezone":"","root":"/dmsdk/","time_format":"HH:mm:ss","theme":"../node_modules/hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot=""><nav class="doc-navbar"><a href="/dmsdk/" class="doc-navbar__logo"><img src="/dmsdk/images/logo.png" class="doc-navbar__logo__img"/><span class="doc-navbar__logo__text">文档归档</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <h1 id="QQ音乐授权"><a href="#QQ音乐授权" class="headerlink" title="QQ音乐授权"></a>QQ音乐授权</h1><p>通过DMSDK接入QQ音乐授权后，用户在登录账号后便能将该账号与其QQ音乐账号绑定，并使音箱能通过TVS服务访问用户QQ音乐账号上的音乐资产。</p>
<p>要接入QQ音乐授权，您需要准备好若干材料，向QQ音乐递交以获取您的应用信息。请<strong>提前五个工作日</strong>发送邮件向QQ音乐提交申请，邮件内容如下：<br><br/></p>
<blockquote>
<ul>
<li>邮件标题：OpenID申请-XXXXX公司</li>
<li>邮件收件人：<a href="mailto:shuozhao@tencent.com">shuozhao@tencent.com</a></li>
<li>邮件抄送：<a href="mailto:tangotang@tencent.com">tangotang@tencent.com</a>;kenzimo@tencent.com</li>
<li>邮件正文:<ol>
<li>组织名称：XX公司</li>
<li>应用名称：XXX</li>
<li>联系人名：（接口人即可）</li>
<li>联系电话：（接口人即可）</li>
<li>联系邮件：（接受账号开通信息）</li>
<li>应用包名：（包含Android、iOS包名，如果有多个包名就用;分割）</li>
<li>应用图标：（ 文件，不超过1000KB）</li>
<li>业务公钥：</li>
</ol>
</li>
</ul>
<p>其中QQ音乐OpenID授权方案使用的RSA业务密钥位数为1024位，密钥格式使用PKCS#8， 使用OpenSSL来生成的示例如下：</p>
<ul>
<li><p>生成原始RSA私钥文件rsa_private_key.pem：<code>openssl genrsa -out rsa_private_key.pem 1024</code></p>
</li>
<li><p>将原始RSA私钥转换为pkcs8格式，得到私钥文件private_key.pem：<code>openssl pkcs8 -topk8 -inform PEM -in rsa_private_key.pem -outform PEM -nocrypt -out private_key.pem</code></p>
</li>
<li><p>生成RSA公钥文件rsa_public_key.pem：<code>openssl rsa -in rsa_private_key.pem -pubout -out rsa_public_key.pem</code></p>
</li>
<li><p>生成成功后，<strong>将公钥文件rsa_public_key.pem给QQ音乐</strong>，pkcs8格式的私钥<strong>private_key.pem</strong>合作方妥善保管</p>
</li>
</ul>
<p>在完成申请，得到您的应用信息后，您就可以参考下面的文档了解方案的整体流程与接入的技术细节。在接入的开发实现过程中，您需要用到以下信息：</p>
<ul>
<li><p><strong>QQ音乐AppID</strong>，由QQ音乐为您分配，一般是一个数字，如“1”；</p>
</li>
<li><p><strong>回调URL</strong>，是您的应用可以响应的URI Scheme协议，用于被QQ音乐应用拉起，为了避免和其他应用冲突，建议在其中包含您的QQ音乐AppID，如“qqmusic1://”；</p>
</li>
<li><p><strong>RSA私钥</strong>，如前所述，由您在提交申请前自行生成，并在开发过程中作为参数传入。</p>
</li>
</ul>
<p><strong>注意</strong>，RSA私钥的使用方式需要关注。如前所述，您需要使用的是pkcs8格式的private_key.pem，使用文本编辑工具打开形如下图：</p>
<p><img src="https://3gimg.qq.com/trom_s/dingdang/upload/20191204/856372591f1acb06783688ba2f05b12d.png" alt=""></p>
<p>您需要移除开头、结尾的分割线，并移除换行符，最终变为单行的字符串，如下图：</p>
<p><img src="https://3gimg.qq.com/trom_s/dingdang/upload/20191204/88f95b722aadf756cfc9321ab68ae10c.png" alt=""></p>
<p>在使用DM SDK接入过程中，需要传入密钥参数的时候，传入该单行字符串。</p>
</blockquote>
<p>本文档是DM SDK Android版接入QQ音乐拉起应用授权的开发指南，请先完整阅读<a href="/doc/page/365">云小微账号</a>，以确保能够顺利理解本文档中提及的各参数和概念的含义。</p>
<h2 id="引入SDK依赖"><a href="#引入SDK依赖" class="headerlink" title="引入SDK依赖"></a>引入SDK依赖</h2><p>在应用的build.gradle文件中引入以下依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/build.gradle</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    flatDir &#123;</span><br><span class="line">        dirs <span class="string">'libs'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> dmsdkVer = <span class="string">'2.2.1'</span></span><br><span class="line">    api <span class="string">"com.tencent.yunxiaowei.dmsdk:core:$dmsdkVer"</span>              <span class="comment">// DMSDK核心库</span></span><br><span class="line">    api <span class="string">"com.tencent.yunxiaowei.dmsdk:tskm:$dmsdkVer"</span>              <span class="comment">// 包含QQ音乐授权接口</span></span><br><span class="line">    api <span class="string">"com.tencent.yunxiaowei.webviewsdk:webviewsdk:$dmsdkVer"</span>   <span class="comment">// 用于呈现QQ音乐授权页面</span></span><br><span class="line">    api(<span class="string">name:</span> <span class="string">'qqmusic-innovation-aidl-api-sdk-1.0.0-SNAPSHOT-release'</span>, <span class="string">ext:</span> <span class="string">'aar'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并将QQ音乐提供的aar文件放在对应的路径上。您可以在<a href="https://github.com/TencentDingdang/dmsdk/blob/master/demo/Android/TVSLogin/app/libs/qqmusic-innovation-aidl-api-sdk-1.0.0-SNAPSHOT-release.aar" target="_blank" rel="noopener">我们的demo中</a>获取QQ音乐的该aar文件。</p>
<h2 id="初始化DMSDK与WebViewSDK"><a href="#初始化DMSDK与WebViewSDK" class="headerlink" title="初始化DMSDK与WebViewSDK"></a>初始化DMSDK与WebViewSDK</h2><p>初始化DMSDK，并将TSKM模块接入WebView SDK：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="comment">// 初始化DMSDK</span></span><br><span class="line">        LoginProxy.getInstance().registerApp(<span class="keyword">this</span>, <span class="string">"wx-app-id"</span>, <span class="string">"qq-app-id"</span>);</span><br><span class="line">        <span class="comment">// 使WebViewSDK具备第三方CP授权能力</span></span><br><span class="line">        TVSThirdPartyAuth.setupWithWeb();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化DMSDK的详细文档参考<a href="/doc/page/270">接入指南</a>。</p>
<p>接下来请参考<a href="/doc/page/293">WebView SDK接入</a>接入WebView SDK，以便在QQ音乐授权流程中展示授权状态页面。</p>
<h2 id="接入QQ音乐QPlaySDK"><a href="#接入QQ音乐QPlaySDK" class="headerlink" title="接入QQ音乐QPlaySDK"></a>接入QQ音乐QPlaySDK</h2><p>为了便于定制，第三方CP授权的流程中部分流程需要您自行实现，只需要根据下述文档实现后注入到DM SDK的TSKM模块，DMSDK和WebView SDK就能够调用相应的逻辑完成整个授权流程。</p>
<p>同时，您也可以直接从demo中拷贝<code>com.tencent.yunxiaowei.dmsdk.cpaa.qqmusic</code>包路径下提供的默认实现，其中<code>QQMusicAuthAgent</code>即为默认实现，您可以直接使用或根据需求修改。</p>
<p>若选择自行实现，则需要新建一个类，实现<code>CpAuthAgent</code>接口，以供DM SDK调用：</p>
<ul>
<li>在<code>requestCpAuthCredential</code>中实现拉起QQ音乐授权的逻辑，并在授权成功后通过参数中的回调返回OpenID、OpenToken和ExpireTime；</li>
<li>在<code>checkCpAppInstallation</code>中实现判断QQ音乐是否已经安装的逻辑；</li>
<li>在<code>jumpToAppDownload</code>中实现跳转到商店页引导用户下载QQ音乐的逻辑。</li>
</ul>
<p>您可以参考默认实现的<code>QQMusicAuthAgent</code>熟悉各接口需要实现的内容。</p>
<p>将实现好的类在初始化后注入到TSKM模块中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="comment">// 初始化DMSDK</span></span><br><span class="line">        LoginProxy.getInstance().registerApp(<span class="keyword">this</span>, <span class="string">"wx-app-id"</span>, <span class="string">"qq-app-id"</span>);</span><br><span class="line">        <span class="comment">// 使WebViewSDK具备第三方CP授权能力</span></span><br><span class="line">        TVSThirdPartyAuth.setupWithWebViewSDK();</span><br><span class="line">        <span class="comment">// 在这里将您的实现注入到TSKM模块，注意参数中填入您申请的QQ音乐AppID、密钥和配置对应的回调URL</span></span><br><span class="line">        TVSThirdPartyAuth.setCpAuthAgent(ThirdPartyCp.QQ_MUSIC, <span class="keyword">new</span> QQMusicAuthAgent(<span class="keyword">this</span>, <span class="string">"QQ_MUSIC_APP_ID"</span>, <span class="string">"AppPrivateKey"</span>, <span class="string">"QQ_MUSIC_CALLBACK_URL"</span>, DemoConstant.QQ_MUSIC_DOWNLOAD_URL));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，为应用配置QQ音乐回调的URL，需要和前面注入到QQMusicAuthAgent中传入的一致，建议配置为<code>qqmusic&lt;APP_ID&gt;://</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">"com.tencent.yunxiaowei.dmsdk.cpaa.qqmusic.QQMusicAuthResultActivity"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.VIEW"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.BROWSABLE"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"qqmusic1"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一种正确的配置结果如下图所示：</p>
<p><img src="https://3gimg.qq.com/trom_s/dingdang/upload/20191115/9dbfba26f64586a5cba6a06f69c362a6.png" alt="qqmusicconfig.png"></p>
<blockquote>
<p>请注意参照QQ音乐提供的文档，从pkcs8格式的私钥文件private_key.pem中取出符合格式要求的私钥字符串。</p>
</blockquote>
<h2 id="主账号登录与设备绑定"><a href="#主账号登录与设备绑定" class="headerlink" title="主账号登录与设备绑定"></a>主账号登录与设备绑定</h2><p>在用户能够进行授权之前，需要用户完成登录和设备绑定流程。</p>
<p>调用如下接口拉起微信或QQ登录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LoginProxy.getInstance().tvsLogin(ELoginPlatform.WX, <span class="keyword">null</span>, <span class="keyword">new</span> TVSCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 登录成功</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 登录失败</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>登录成功后，调用如下的接口完成设备绑定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">TVSDevice device = <span class="keyword">new</span> TVSDevice();</span><br><span class="line">device.productID = <span class="string">"your:product-id"</span>; <span class="comment">// 填入ProductID</span></span><br><span class="line">device.dsn = <span class="string">"1"</span>; <span class="comment">// 填入被绑定设备的DSN</span></span><br><span class="line">LoginProxy.getInstance().bindPushDevice(device, <span class="keyword">new</span> TVSCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 绑定成功</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 绑定失败</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>详细的登录和绑定流程文档请参考：<a href="/doc/page/296">云小微账号</a>。</p>
<h2 id="展示QQ音乐授权页面开始授权"><a href="#展示QQ音乐授权页面开始授权" class="headerlink" title="展示QQ音乐授权页面开始授权"></a>展示QQ音乐授权页面开始授权</h2><p>QQ音乐授权的页面使用Web方式呈现，使用TVSWebView组件来展示Web页面。在展示之前，首先需要注入设备信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TVSDevice tvsDevice = <span class="keyword">new</span> TVSDevice();</span><br><span class="line">tvsDevice.productID = <span class="string">"your:product-id"</span>;</span><br><span class="line">tvsDevice.dsn = <span class="string">"1"</span>;</span><br><span class="line">mTVSWebView.getController().setDeviceInfo(tvsDevice);</span><br></pre></td></tr></table></figure>

<p>注意这里填入的设备信息应该和前面绑定设备时传入的一致，传入需要被授权使用音乐服务的设备的信息。</p>
<p>注入设备信息后，通过下面的方式加载QQ音乐授权状态页面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mTVSWebView.getController().loadPresetURLByPath(TVSThirdPartyAuth.getPresetUrlPathByCp(ThirdPartyCp.QQ_MUSIC));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>打开QQ音乐授权页面前，需要事先调用刷票，以保证当前登录主账号的票据有效！</p>
</blockquote>
<p>这段代码会在对应的TVSWebView中呈现QQ音乐授权状态的页面，在用户未授权时，会展示下图的授权请求UI：</p>
<p><img src="https://3gimg.qq.com/trom_s/dingdang/upload/20191106/b15e8f3b28ea1659d4f549c8332aa46e.png" alt="androidqqmusicnotauth.png"></p>
<p>用户点击授权按钮后会调用前面实现的Agent相关接口，拉起QQ音乐完成授权。授权成功回到该页面后，页面会自动刷新，呈现已经绑定的UI，用户可以看到自己的QQ音乐账号信息，如会员状态等：</p>
<p><img src="https://3gimg.qq.com/trom_s/dingdang/upload/20191106/e546f849e6378b89ccb4c0b03bbd00f0.png" alt="androidqqmusichasauth.png"></p>
<p>需要用户解除绑定时，也可以通过同样的方式打开该页面引导用户解绑。</p>
<h2 id="技能账号授权管理"><a href="#技能账号授权管理" class="headerlink" title="技能账号授权管理"></a>技能账号授权管理</h2><p><a href="https://github.com/TencentDingdang/tvs-tools/blob/master/Tsk%20Protocol/domains_V3/TSKOAuth.md" target="_blank" rel="noopener">查询技能的账号绑定状态</a></p>
<h2 id="获取授权结果通知"><a href="#获取授权结果通知" class="headerlink" title="获取授权结果通知"></a>获取授权结果通知</h2><p>在上述流程中，授权完成后会展示用户的QQ音乐账号的信息，若您需要执行其他操作（如关闭该页面、跳转到点播页面等），则可以监听ProxyData：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBusinessEventListener</span> <span class="keyword">implements</span> <span class="title">TVSWebController</span>.<span class="title">BusinessEventListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceiveProxyData</span><span class="params">(JSONObject data)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, data.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Other methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在授权结束后，会收到如下的JSON字符串：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"action"</span>: <span class="string">"cpAuthResult"</span>,</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"cp"</span>: <span class="string">"qq_music"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您可以通过<code>action</code>过滤出授权结果，通过<code>data.code</code>字段判断是否授权成功，此处的错误码和<code>CpAuthError</code>类中的定义一致。</p>
<p>鉴权失败(如DSN无效)，proxyData通知</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"action"</span>: <span class="string">"cpGetUserInfoErr"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"cp"</span>: <span class="string">"qq_music"</span>,</span><br><span class="line">        <span class="attr">"code"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"errMsg"</span>: <span class="string">"DSN鉴权失败"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求H5页面，后台通知H5设备未入库时，H5回调通知到本地，proxyData通知</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"action"</span>: <span class="string">"cpGetUserInfoErr"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"cp"</span>: <span class="string">"qq_music"</span>,</span><br><span class="line">        <span class="attr">"code"</span>: <span class="number">6</span>,</span><br><span class="line">        <span class="attr">"errMsg"</span>: <span class="string">"invalid cp"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cp解除绑定结果 ：proxyData</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"action"</span>: <span class="string">"cpUnbindUserDevice"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"cp"</span>: <span class="string">"qq_music"</span>,</span><br><span class="line">        <span class="attr">"code"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/dmsdk/script/doc.js"></script>

    

  </body>
</html>
