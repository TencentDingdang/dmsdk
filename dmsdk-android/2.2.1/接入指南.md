# 接入指南

以下流程（从注册AppID到Manifest配置）适用于新接入本SDK，如果您需要从原有的SDK迁移到新版本，请参阅[常见问题](/doc/page/307)中的相关章节，其中有针对每个版本的API变更和就版本迁移指南。**新版本会带来更多特性、修复缺陷，请尽量保持使用最新的SDK版本。**

DMSDK Android提供[Javadoc](https://tencentdingdang.github.io/dmsdk/android/latest-redirect.html)作为API文档。

您可以在[TencentDingdang/dmsdk: 腾讯叮当 TVS 手机端 SDK.](https://github.com/TencentDingdang/dmsdk)获取demo工程代码。

DM SDK使用了Java 8的特性，您可能需要配置项目以支持Java 8特性，请参考[谷歌的官方文档](https://developer.android.com/studio/write/java8-support)。

DM SDK依赖AndroidX，如果您的项目依赖的是Android Support Library，请参考[谷歌的官方文档](https://developer.android.com/jetpack/androidx/migrate)迁移到AndroidX。

## 一、配置Gradle脚本

打开工程app目录下的build.gradle。

配置依赖：

```groovy
dependencies {
    // ...
    def tvsVer = '2.2.1'
    // 核心模块，被其他组件依赖
    implementation "com.tencent.yunxiaowei.dmsdk:core:$tvsVer"
    // AI Speech模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:aispeech:$tvsVer"
    // QQ音乐会员模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:member:$tvsVer"
    // TSKM技能服务模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:tskm:$tvsVer"
    // WebView SDK，原HTML5 WebView模块
    implementation "com.tencent.yunxiaowei.webviewsdk:webviewsdk:$tvsVer"
    // 微信登录，如果需要微信登录功能则必须
    implementation 'com.tencent.mm.opensdk:wechat-sdk-android-with-mta:5.4.0'
    // QQ登录，如果需要QQ登录功能则必须
    implementation files('libs/open_sdk_r6052_lite.jar')
    // QQ登录SDK的依赖，如果需要QQ登录功能则必须
    implementation 'androidx.fragment:fragment:1.0.0'
}
```

确保minSdkVersion大于等于15。

DMSDK已经通过ConsumerProguard自动支持ProGuard配置，不需要您为DMSDK额外配置ProGuard文件。

## 二、接入微信、QQ登录

为了使用DMSDK的微信登录和QQ登录功能，需要进行以下配置。

### 1 准备App ID

在[微信开放平台](https://open.weixin.qq.com/)和[QQ互联平台](https://connect.qq.com/index.html)注册App ID。注意确保申请时填写的包名和应用包名一致、并确保signingConfigs目录下storeFile.file参数路径正确，keyAlias、keyPassword、storePassword均与微信开放平台下签名参数一致。

> 要接入微信登录或QQ登录，必须为您的App申请专用的App ID，demo中测试用的App ID仅能用于demo。如果您在注册App ID时遇到问题，请阅读其提供的文档，或在其页面上找到反馈链接反馈问题。微信开放平台的文档为：[资源中心 - 微信开放平台](https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&lang=zh_CN)，QQ互联平台的文档为：[QQ互联WIKI](https://wiki.connect.qq.com/)。

### 2 配置项目

打开工程AndroidManifest.xml。

如果要接入微信，需要在application标签下添加以下内容：

```xml
<activity
    android:name="com.tencent.ai.tvs.WXEntryActivity"
    android:exported="true"
    android:launchMode="singleTask" />
<activity-alias
    android:name="${applicationId}.wxapi.WXEntryActivity"
    android:exported="true"
    android:launchMode="singleTask"
    android:targetActivity="com.tencent.ai.tvs.WXEntryActivity" />
```

`com.tencent.ai.tvs.WXEntryActivity`是DMSDK提供的WXEntryActivity默认实现。

如果需要自定义该Activity的实现，则需要在onReq和onResp中调用DMSDK的相关接口，如下所示：

```java
@Override
public void onReq(BaseReq baseReq) {
    if (!LoginProxy.getInstance().onReq(baseReq)) {
        // 在此处添加您的自定义实现
        Toast.makeText(this, "DMSDK didn't handle onReq", Toast.LENGTH_SHORT).show();
    }
}

@Override
public void onResp(BaseResp baseResp) {
    if (!LoginProxy.getInstance().onResp(baseResp)) {
        // 在此处添加您的自定义实现，如响应微信分享回调
        Toast.makeText(this, "DMSDK didn't handle onResp", Toast.LENGTH_SHORT).show();
    }
}
```

详细请参考demo工程中提供的示例WXEntryActivity类。

如果要接入QQ登录，则需要在Manifest中的application标签下添加以下内容：

```xml
<activity
    android:name="com.tencent.tauth.AuthActivity"
    android:launchMode="singleTask"
    android:noHistory="true">
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <!-- 注意：此处您需要按照QQ互联的文档配置您申请的QQ登录API -->
        <data android:scheme="tencent101470979" />
    </intent-filter>
</activity>
<activity
    android:name="com.tencent.connect.common.AssistActivity"
    android:configChanges="orientation|keyboardHidden"
    android:screenOrientation="behind"
    android:theme="@android:style/Theme.Translucent.NoTitleBar" />
```

注意需要将示例中的AppID改为自己在QQ互联平台注册的AppID。

然后在需要启动QQ登录的Activiity处配置onActivityResult：

```java
@Override
protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    if (LoginProxy.getInstance().handleQQOpenIntent(requestCode, resultCode, data)) {
        return;
    }
    super.onActivityResult(requestCode, resultCode, data);
}
```

注意，当您拉起登录时，传入的Activity参数必须是配置了上述onActivityResult的Activity：

```java
LoginProxy.getInstance().tvsLogin(ELoginPlatform.QQOpen, this, someCallback);
```

以上接入流程基于微信和QQ的登录SDK的官方接入文档，详细请参考对应的文档。

## 三、Application配置

将Manifest中的application的name改为自定义的Application类，然后在其中的`onCreate`中加入如下初始化代码（以微信、QQ登录方式为例）：

```java
public class YourApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();

        // 初始化TVS账号体系模块，依次传入应用上下文、微信AppID和QQ互联AppID；如果只需要支持一种登录平台，则另一个平台的AppID直接传入空字符串即可
        LoginProxy.getInstance().registerApp(this, "YOUR_WEIXIN_APPID", "YOUR_QQ_OPEN_APPID");
        // 如果集成了TSKM模块，则需要注入逻辑到WebView SDK
        TVSThirdPartyAuth.setupWithWeb();
    }
}
```
